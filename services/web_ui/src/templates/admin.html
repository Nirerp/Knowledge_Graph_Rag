{% extends "base.html" %}

{% block title %}Admin - Graph RAG{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>System Dashboard</h1>
        <p class="subtitle">Monitor your Graph RAG infrastructure</p>
        <button class="refresh-btn" onclick="refreshStats()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Refresh
        </button>
    </div>
    
    <div class="stats-grid">
        <!-- Qdrant Card -->
        <div class="stat-card">
            <div class="card-header">
                <div class="card-icon qdrant">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </div>
                <div class="card-title">
                    <h2>Qdrant</h2>
                    <span class="status-badge {{ 'connected' if qdrant.status == 'connected' else 'disconnected' }}">
                        {{ qdrant.status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if qdrant.status == 'connected' %}
                <div class="stat-row">
                    <span class="stat-label">Collection</span>
                    <span class="stat-value">{{ qdrant.collection or 'None' }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Vectors</span>
                    <span class="stat-value highlight">{{ qdrant.vectors_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Points</span>
                    <span class="stat-value">{{ qdrant.points_count }}</span>
                </div>
                {% else %}
                <p class="error-text">{{ qdrant.error }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Neo4j Card -->
        <div class="stat-card">
            <div class="card-header">
                <div class="card-icon neo4j">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="6" cy="6" r="3"/>
                        <circle cx="18" cy="18" r="3"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="6" r="3"/>
                        <line x1="8.5" y1="8.5" x2="15.5" y2="15.5"/>
                        <line x1="8.5" y1="15.5" x2="15.5" y2="8.5"/>
                    </svg>
                </div>
                <div class="card-title">
                    <h2>Neo4j</h2>
                    <span class="status-badge {{ 'connected' if neo4j.status == 'connected' else 'disconnected' }}">
                        {{ neo4j.status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if neo4j.status == 'connected' %}
                <div class="stat-row">
                    <span class="stat-label">Entity Nodes</span>
                    <span class="stat-value highlight">{{ neo4j.entity_nodes }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Chunk Nodes</span>
                    <span class="stat-value">{{ neo4j.chunk_nodes }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Relationships</span>
                    <span class="stat-value">{{ neo4j.total_relationships }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">MENTIONS</span>
                    <span class="stat-value">{{ neo4j.mentions_relationships }}</span>
                </div>
                {% else %}
                <p class="error-text">{{ neo4j.error }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Ollama Card -->
        <div class="stat-card">
            <div class="card-header">
                <div class="card-icon ollama">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                </div>
                <div class="card-title">
                    <h2>Ollama</h2>
                    <span class="status-badge {{ 'connected' if ollama.status == 'connected' else 'disconnected' }}">
                        {{ ollama.status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if ollama.status == 'connected' %}
                <div class="stat-row">
                    <span class="stat-label">Models Loaded</span>
                    <span class="stat-value highlight">{{ ollama.model_count }}</span>
                </div>
                <div class="models-list">
                    {% for model in ollama.models %}
                    <span class="model-tag">{{ model }}</span>
                    {% endfor %}
                </div>
                {% else %}
                <p class="error-text">{{ ollama.error }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Danger Zone -->
    <div class="danger-zone">
        <h3>Danger Zone</h3>
        <p>These actions cannot be undone. Be careful!</p>
        <button class="danger-btn" onclick="clearAllData()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            Clear All Data
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function refreshStats() {
    const btn = document.querySelector('.refresh-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Loading...';
    
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        // Reload the page to show updated stats
        window.location.reload();
    } catch (error) {
        alert('Error refreshing stats: ' + error.message);
    }
    
    btn.disabled = false;
}

async function clearAllData() {
    if (!confirm('Are you sure you want to delete ALL data from Qdrant and Neo4j? This cannot be undone!')) {
        return;
    }
    
    if (!confirm('FINAL WARNING: This will permanently delete all vectors and graph data. Continue?')) {
        return;
    }
    
    const btn = document.querySelector('.danger-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Clearing...';
    
    try {
        const response = await fetch('/api/clear-data', { method: 'POST' });
        const data = await response.json();
        
        let message = 'Results:\n';
        if (data.qdrant) {
            message += `Qdrant: ${data.qdrant.success ? data.qdrant.message : data.qdrant.error}\n`;
        }
        if (data.neo4j) {
            message += `Neo4j: ${data.neo4j.success ? data.neo4j.message : data.neo4j.error}`;
        }
        
        alert(message);
        window.location.reload();
    } catch (error) {
        alert('Error clearing data: ' + error.message);
    }
    
    btn.disabled = false;
    btn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
        Clear All Data
    `;
}
</script>

<style>
/* Admin Page Specific Styles */
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-xl);
}

.admin-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-2xl);
    flex-wrap: wrap;
    gap: var(--space-md);
}

.admin-header h1 {
    font-size: 28px;
    font-weight: 600;
}

.refresh-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition-fast);
}

.refresh-btn:hover:not(:disabled) {
    background: var(--bg-elevated);
    border-color: var(--accent-primary);
}

.refresh-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
}

.stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.card-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-color);
}

.card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-icon.qdrant {
    background: linear-gradient(135deg, #e91e63, #9c27b0);
    color: white;
}

.card-icon.neo4j {
    background: linear-gradient(135deg, #018bff, #00c4ff);
    color: white;
}

.card-icon.ollama {
    background: linear-gradient(135deg, var(--accent-primary), #ff6b00);
    color: white;
}

.card-title h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: var(--space-xs);
}

.status-badge {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
}

.status-badge.connected {
    background: rgba(63, 185, 80, 0.15);
    color: var(--success);
}

.status-badge.disconnected {
    background: rgba(248, 81, 73, 0.15);
    color: var(--error);
}

.card-body {
    padding: var(--space-md);
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--border-color);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 14px;
}

.stat-value {
    font-family: var(--font-mono);
    font-size: 14px;
}

.stat-value.highlight {
    color: var(--accent-primary);
    font-weight: 600;
    font-size: 18px;
}

.error-text {
    color: var(--error);
    font-size: 13px;
    word-break: break-word;
}

.models-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-top: var(--space-md);
}

.model-tag {
    font-size: 12px;
    font-family: var(--font-mono);
    background: var(--bg-tertiary);
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

/* Danger Zone */
.danger-zone {
    background: rgba(248, 81, 73, 0.05);
    border: 1px solid rgba(248, 81, 73, 0.3);
    border-radius: var(--border-radius);
    padding: var(--space-lg);
}

.danger-zone h3 {
    color: var(--error);
    font-size: 16px;
    margin-bottom: var(--space-sm);
}

.danger-zone p {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: var(--space-md);
}

.danger-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: 1px solid var(--error);
    border-radius: var(--border-radius-sm);
    color: var(--error);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-fast);
}

.danger-btn:hover:not(:disabled) {
    background: var(--error);
    color: white;
}

.danger-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

